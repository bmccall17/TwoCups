name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to Firebase Hosting

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: TwoCupsApp/package-lock.json

      - name: Install dependencies
        working-directory: TwoCupsApp
        run: npm ci

      - name: Build web app
        working-directory: TwoCupsApp
        run: npm run build:web

      - name: Verify build output
        working-directory: TwoCupsApp
        run: |
          echo ""
          echo "========================================"
          echo "  ğŸ” VERIFYING BUILD OUTPUT"
          echo "========================================"
          echo ""

          REQUIRED_FILES=(
            "dist/index.html"
            "dist/sw.js"
            "dist/manifest.json"
            "dist/build-manifest.json"
            "dist/assets/icon.png"
            "dist/assets/adaptive-icon.png"
            "dist/assets/favicon.png"
          )

          MISSING=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ -f "$file" ]]; then
              echo "âœ… $file"
            else
              echo "âŒ MISSING: $file"
              MISSING=$((MISSING + 1))
            fi
          done

          echo ""

          if [[ $MISSING -gt 0 ]]; then
            echo "========================================"
            echo "  âŒ BUILD VERIFICATION FAILED"
            echo "  $MISSING required files missing!"
            echo "========================================"
            exit 1
          fi

          FILE_COUNT=$(find dist -type f | wc -l)
          echo "ğŸ“¦ Total files in dist: $FILE_COUNT"
          echo ""
          echo "âœ… All required files present!"

      - name: Display deployment banner
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                              â•‘"
          echo "â•‘   ğŸš€ DEPLOYING TWO CUPS TO FIREBASE HOSTING                  â•‘"
          echo "â•‘                                                              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                              â•‘"
          echo "â•‘   Commit SHA:    ${{ github.sha }}"
          echo "â•‘   Commit Short:  ${GITHUB_SHA::7}"
          echo "â•‘   Branch:        ${{ github.ref_name }}"
          echo "â•‘   Triggered by:  ${{ github.actor }}"
          echo "â•‘   Timestamp:     $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â•‘   Public Dir:    TwoCupsApp/dist"
          echo "â•‘                                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: twocups-2026

      - name: Post-deploy confirmation
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                              â•‘"
          echo "â•‘   âœ… DEPLOYMENT COMPLETE                                     â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•‘   Site: https://twocups-2026.web.app                         â•‘"
          echo "â•‘   Commit: ${GITHUB_SHA::7}                                   â•‘"
          echo "â•‘   Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')                  â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
