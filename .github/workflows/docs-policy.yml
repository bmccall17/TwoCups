name: Documentation Policy Enforcement

on:
  pull_request:
    paths:
      - '**.md'
      - '.github/workflows/docs-policy.yml'

jobs:
  check-docs-policy:
    runs-on: ubuntu-latest
    name: Enforce Documentation Governance
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **.md

      - name: Check for markdown files outside /docs
        run: |
          # Allowlisted markdown files in root
          ALLOWLIST="README.md|AGENTS.md|SHIPLOG.md|LICENSE.md|CONTRIBUTING.md"

          # Get all changed markdown files
          if [ -n "${{ steps.changed-files.outputs.all_changed_files }}" ]; then
            for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
              # Check if file is in root (not in a subdirectory)
              if [[ ! "$file" =~ "/" ]]; then
                # Check if it's in the allowlist
                if [[ ! "$file" =~ ^($ALLOWLIST)$ ]]; then
                  echo "‚ùå ERROR: New markdown file '$file' is in root directory"
                  echo "üìã All docs must go in /docs/ subdirectories"
                  echo "‚ÑπÔ∏è  Allowlisted root docs: $ALLOWLIST"
                  exit 1
                fi
              fi
            done
          fi

      - name: Check if docs/README.md was updated when adding new docs
        run: |
          # Check if any new markdown files were added to /docs
          NEW_DOCS=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- "docs/**/*.md" 2>/dev/null || echo "")

          if [ -n "$NEW_DOCS" ]; then
            # Check if docs/README.md was modified
            README_UPDATED=$(git diff --name-only HEAD~1 HEAD -- "docs/README.md" 2>/dev/null || echo "")

            if [ -z "$README_UPDATED" ]; then
              echo "‚ö†Ô∏è  WARNING: New documentation files added but docs/README.md was not updated"
              echo ""
              echo "New files:"
              echo "$NEW_DOCS"
              echo ""
              echo "Please update docs/README.md to add these files to the table of contents."
              echo "See: docs/GOVERNANCE.md#how-to-add-a-new-doc-3-steps"
              echo ""
              echo "Note: This is a warning, not a blocker. But please update the TOC!"
            fi
          fi

      - name: Verify header blocks in new docs
        run: |
          # Get new markdown files in /docs
          NEW_DOCS=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- "docs/**/*.md" 2>/dev/null || echo "")

          MISSING_HEADERS=0

          if [ -n "$NEW_DOCS" ]; then
            for file in $NEW_DOCS; do
              # Check for required header fields
              if ! grep -q "^**Status:**" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file missing 'Status:' header"
                MISSING_HEADERS=$((MISSING_HEADERS + 1))
              fi
              if ! grep -q "^**Owner:**" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file missing 'Owner:' header"
                MISSING_HEADERS=$((MISSING_HEADERS + 1))
              fi
              if ! grep -q "^**Last Updated:**" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file missing 'Last Updated:' header"
                MISSING_HEADERS=$((MISSING_HEADERS + 1))
              fi
            done

            if [ $MISSING_HEADERS -gt 0 ]; then
              echo ""
              echo "üìã New docs should include header blocks with metadata."
              echo "See: docs/templates/ for template examples"
              echo "Docs: docs/GOVERNANCE.md#doc-header-block-required"
            fi
          fi

      - name: Check investigations format
        run: |
          # Get new investigation files
          NEW_INVESTIGATIONS=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- "docs/investigations/**/*.md" 2>/dev/null || echo "")

          ISSUES=0

          if [ -n "$NEW_INVESTIGATIONS" ]; then
            for file in $NEW_INVESTIGATIONS; do
              # Skip the README
              if [[ "$file" == "docs/investigations/README.md" ]]; then
                continue
              fi

              # Check for YYYY-MM-DD naming
              if [[ ! "$file" =~ docs/investigations/[0-9]{4}-[0-9]{2}-[0-9]{2}- ]]; then
                echo "‚ö†Ô∏è  WARNING: $file should use YYYY-MM-DD- prefix (e.g., docs/investigations/2026-01-19-slug.md)"
                ISSUES=$((ISSUES + 1))
              fi

              # Check for required investigation headers
              if ! grep -q "^**Status:**" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file missing 'Status:' header"
                ISSUES=$((ISSUES + 1))
              fi
              if ! grep -q "^**Owner:**" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file missing 'Owner:' header"
                ISSUES=$((ISSUES + 1))
              fi
              if ! grep -q "^**Created:**" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file missing 'Created:' header"
                ISSUES=$((ISSUES + 1))
              fi
              if ! grep -q "^**Last Updated:**" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file missing 'Last Updated:' header"
                ISSUES=$((ISSUES + 1))
              fi

              # Check for required sections
              if ! grep -q "^## Problem" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file missing 'Problem / Symptoms' section"
                ISSUES=$((ISSUES + 1))
              fi
              if ! grep -q "^## Root Cause" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file missing 'Root Cause' section"
                ISSUES=$((ISSUES + 1))
              fi
              if ! grep -q "^## Fix" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file missing 'Fix' section"
                ISSUES=$((ISSUES + 1))
              fi
            done

            if [ $ISSUES -gt 0 ]; then
              echo ""
              echo "üìã Investigations should follow the template: docs/templates/investigation.md"
              echo "See: docs/GOVERNANCE.md#shiplog--investigations-policy"
            fi
          fi

      - name: Summary
        if: success()
        run: |
          echo "‚úÖ Documentation policy checks passed!"
          echo ""
          echo "üìñ Quick reference:"
          echo "  - New docs must go in docs/ subdirectories"
          echo "  - Root-level docs: README.md, AGENTS.md, SHIPLOG.md only"
          echo "  - Use docs/README.md to link all docs"
          echo "  - See docs/GOVERNANCE.md for details"
