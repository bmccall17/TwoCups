# Ralph Progress Log
Started: 2026-01-14

## Codebase Patterns
- Firebase JS SDK used (not @react-native-firebase) for web compatibility
- User documents auto-created on anonymous auth in AuthContext
- Use `writeBatch()` for atomic multi-document operations
- Firestore security rules require `createdAt` field on user documents
- Use `getDocs` + pagination (startAfter, limit) for History-style screens (not onSnapshot)
- FlatList with onEndReached for infinite scroll pattern

---

## 2026-01-14 - US-001 (Fix Auth Flow) âœ…
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
Fixed anonymous auth flow that was failing due to race condition:
1. AuthContext now auto-creates user document on anonymous sign-in
2. Added proper cleanup of Firestore listeners on auth state change
3. Fixed Firestore security rules for join flow

### Files changed
- `TwoCupsApp/src/context/AuthContext.tsx` - Auto-create user doc, fix listeners
- `firestore.rules` - Relaxed rules for join flow (read users, couples, players)

### Learnings
- Anonymous auth doesn't auto-create user documents - must do it manually
- Firestore security rules must allow reading partner's user doc for join flow
- Use `firebase deploy` (not `--only hosting`) for reliable deploys

---

## 2026-01-14 - US-002 (HomeScreen with Cup Visualizations) âœ…
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
- CupVisualization component with fill level display
- usePlayerData hook for real-time player data from Firestore
- HomeScreen shows My Cup, Partner Cup, Collective Cup with gem counts
- Navigation buttons for Make Request, Log Attempt, Acknowledge

### Files created
- `src/components/cups/CupVisualization.tsx`
- `src/hooks/usePlayerData.ts`
- `src/hooks/index.ts`

---

## 2026-01-14 - US-003 (Log Attempt Screen) âœ…
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
- LogAttemptScreen with action input, description, category picker
- Shows partner's active requests at top (for fulfillment bonus)
- Submits attempt to Firestore, awards gems
- Navigation from HomeScreen working

### Files created
- `src/screens/LogAttemptScreen.tsx`

### Status
Deployed, and works.

---

## 2026-01-14 - US-004 (Acknowledge Attempts Screen) âœ…

### What was implemented
Built the Acknowledge Attempts screen where users can review and acknowledge attempts their partner logged for them:

1. **Real-time attempts list**: Fetches attempts where `forPlayerId` equals current user, ordered by `createdAt` desc
2. **Attempt cards show**: action, description, timestamp (relative), who logged it, category badge, fulfilled-request badge
3. **Filter tabs**: Pending / Done / All with counts
4. **Acknowledge button**: Calls existing `acknowledgeAttempt` API which updates:
   - `attempt.acknowledged = true`
   - Awards gems to both players (actor gets +3, recipient gets +3)
   - Updates recipient cup level (with overflow detection)
   - Updates collective cup level
5. **Visual feedback**: Alert on successful acknowledgment with gem count and cup overflow message
6. **Partner name resolution**: Fetches partner displayName from `/users/{uid}` for display

### Files created/changed
- `TwoCupsApp/src/screens/AcknowledgeScreen.tsx` (new)
- `TwoCupsApp/App.tsx`
  - Added import for AcknowledgeScreen
  - Added 'Acknowledge' to AppStackParamList
  - Wired up onNavigateToAcknowledge in HomeScreen
  - Added AppStack.Screen for Acknowledge route

### API already existed
- `acknowledgeAttempt()` in `src/services/api/actions.ts` was already implemented

### Acceptance Criteria Checklist
- [x] Shows list of pending attempts (for current user)
- [x] Each attempt shows: action, description, timestamp, who logged it
- [x] User can tap to acknowledge
- [x] Acknowledging updates: attempt.acknowledged, both gem counts, cups
- [x] Visual feedback on acknowledgment
- [x] Can filter by pending/acknowledged

### Also updated
- Unblocked US-005, US-006, US-007 in prd.json (dependencies now satisfied)

---

## 2026-01-14 - US-005 (Make Request Screen) âœ…
Thread: https://ampcode.com/threads/T-019bbb59-6af9-755a-9257-b2d828861d5a

### What was implemented
Built the Make Request screen where users can request specific actions from their partner:

1. **MakeRequestScreen component** - Form with action, description, and category inputs
2. **Uses existing `createRequest` API** - Already implemented in actions.ts
3. **Navigation wiring** - Added route to App.tsx and connected from HomeScreen

### Files created/changed
- `TwoCupsApp/src/screens/MakeRequestScreen.tsx` (new)
- `TwoCupsApp/App.tsx`
  - Added import for MakeRequestScreen
  - Added 'MakeRequest' to AppStackParamList
  - Wired up onNavigateToMakeRequest in HomeScreen
  - Added AppStack.Screen for MakeRequest route

### Acceptance Criteria Checklist
- [x] User can enter request action text
- [x] User can add optional description
- [x] User can select category
- [x] Submitting creates request doc in Firestore (uses existing createRequest API)
- [x] Request appears in partner's Log Attempt screen (already implemented in US-003)

### Learnings
- The `createRequest` API was already implemented in actions.ts
- LogAttemptScreen already queries for partner's active requests, so new requests auto-appear

---

## 2026-01-14 - US-006 (Manage Suggestions & Requests Screen) âœ…
Thread: https://ampcode.com/threads/T-019bbb5b-58a3-700e-a0b4-8e549f443a96

### What was implemented
Built the Manage Suggestions screen where users can add and manage suggestions for ways their partner can fill their cup:

1. **Suggestion type** added to types/index.ts
2. **API functions** for `createSuggestion` and `deleteSuggestion` in actions.ts
3. **ManageSuggestionsScreen** with:
   - Add suggestion form (action, description, category)
   - View suggestions grouped by category
   - Delete functionality with confirmation
   - Real-time Firestore updates
4. **LogAttemptScreen** updated to show partner's suggestions (ways to fill partner's cup)
5. **HomeScreen** updated with navigation button to ManageSuggestions

### Files created/changed
- `TwoCupsApp/src/types/index.ts` - Added Suggestion interface
- `TwoCupsApp/src/services/api/actions.ts` - Added createSuggestion, deleteSuggestion
- `TwoCupsApp/src/services/api/index.ts` - Export new functions
- `TwoCupsApp/src/screens/ManageSuggestionsScreen.tsx` (new)
- `TwoCupsApp/src/screens/LogAttemptScreen.tsx` - Show partner suggestions
- `TwoCupsApp/src/screens/HomeScreen.tsx` - Add navigation prop/button
- `TwoCupsApp/App.tsx` - Wire up ManageSuggestions route

### Acceptance Criteria Checklist
- [x] User can add new suggestions
- [x] User can view their suggestions grouped by category
- [x] User can delete suggestions
- [x] Suggestions appear in partner's Log Attempt screen

### Learnings
- Suggestions are stored at `/couples/{coupleId}/suggestions/{suggestionId}`
- Partner's suggestions queried by `byPlayerId == partnerId` in LogAttemptScreen
- Grouped display using reduce() to bucket by category

---

## 2026-01-14 - US-007 (Bottom Navigation) âœ…
Thread: https://ampcode.com/threads/T-019bbb5f-b428-77ed-8a92-53cac22a2d72

### What was implemented
Added bottom tab navigation bar to switch between main screens:

1. **Installed @react-navigation/bottom-tabs** - Tab navigation package
2. **Created SettingsScreen** - Displays profile info, couple invite code, quick actions, and sign out
3. **Refactored App.tsx** - Changed from stack-only navigation to nested tabs + stack:
   - MainTabNavigator with 4 tabs: Home, Log, Acknowledge, Settings
   - MakeRequest and ManageSuggestions remain as stack screens (modal-style)
4. **Cleaned up HomeScreen** - Removed redundant Log/Acknowledge buttons since now in tabs

### Files created/changed
- `TwoCupsApp/src/screens/SettingsScreen.tsx` (new)
- `TwoCupsApp/App.tsx` - Refactored to use bottom tabs
- `TwoCupsApp/src/screens/HomeScreen.tsx` - Removed redundant navigation buttons
- `TwoCupsApp/package.json` - Added @react-navigation/bottom-tabs dependency

### Acceptance Criteria Checklist
- [x] Tab bar at bottom of screen
- [x] Tabs: Home, Log, Acknowledge, Settings
- [x] Active tab highlighted (uses primary color)
- [x] Navigation works between all screens

### Learnings
- Bottom tabs work well with nested stack navigation for modal-style screens
- Tab icons using emoji work on both web and mobile
- MakeRequest and ManageSuggestions kept as stack screens since they're not primary tabs

---

## 2026-01-14 - US-008 (Enforce Daily Attempt Limit) âœ…
Thread: https://ampcode.com/threads/T-019bbbb6-a8c2-77bd-bb9e-5144ce28f671

### What was implemented
Enforced the 20 attempts/day limit with clear UI feedback:

1. **getDailyAttemptsInfo API** - Queries attempts created today by current user
2. **logAttempt limit check** - Throws error if limit reached before creating attempt
3. **LogAttemptScreen UI updates**:
   - Displays remaining attempts counter below header
   - Counter shows red styling when limit reached
   - Submit button disabled and text changes when at limit
   - Success alert shows remaining attempts after logging

### Files changed
- `TwoCupsApp/src/services/api/actions.ts` - Added getDailyAttemptsInfo function, added limit check to logAttempt
- `TwoCupsApp/src/services/api/index.ts` - Exported new function and type
- `TwoCupsApp/src/screens/LogAttemptScreen.tsx` - Added attempts counter UI and limit enforcement

### Acceptance Criteria Checklist
- [x] Query today's attempts by current user before allowing log
- [x] If >= 20 attempts today, show error message
- [x] Display remaining attempts count on Log Attempt screen
- [x] Counter resets at midnight (local time)

### Learnings
- Use `Timestamp.fromDate()` to convert JS Date to Firestore Timestamp for queries
- Client-side validation + server-side validation provides best UX
- Style concatenation with opacity (e.g., `colors.error + '20'`) works for semi-transparent backgrounds

---

## 2026-01-14 - US-015 (History Screen with Timeline View) âœ…
Thread: https://ampcode.com/threads/T-019bbd14-8aee-751b-bfc6-59b8e59a7c94

### What was implemented
Built the History screen showing all attempts in reverse chronological order:

1. **HistoryScreen component** - Full timeline of all attempts for the couple
2. **Attempt cards show**: action, description, who logged it (by â†’ for), timestamp, category badge, acknowledged/pending status
3. **Pagination** - Uses Firestore getDocs with startAfter for infinite scroll (20 items per page)
4. **Pull-to-refresh** - RefreshControl for manual refresh
5. **Navigation** - Added as new "History" tab in bottom navigation (between Acknowledge and Settings)

### Files created/changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx` (new)
- `TwoCupsApp/App.tsx` - Added HistoryScreen import, HistoryTab to MainTabParamList, and tab configuration

### Acceptance Criteria Checklist
- [x] New History screen added to navigation (tab)
- [x] Displays all attempts in reverse chronological order
- [x] Each attempt card shows: action, description, who logged it, for whom, timestamp
- [x] Shows acknowledged status with visual indicator (âœ“ badge or pending badge)
- [x] Paginated with infinite scroll (load 20 at a time)
- [x] Pull-to-refresh functionality

### Learnings
- For timeline/history views, use `getDocs` with pagination rather than `onSnapshot` for better control
- FlatList's `onEndReached` + `onEndReachedThreshold` handles infinite scroll nicely
- Player name resolution pattern: fetch all partner names once on mount, display "You" for current user

---

## 2026-01-14 - US-016 (History Filters - By Player) âœ…
Thread: https://ampcode.com/threads/T-019bbd18-c6bb-71b9-bca6-3db6f7cd35ac

### What was implemented
Added player filter chips to the History screen:

1. **PlayerFilterType** - Type for filter options: all, byMe, forMe, byPartner, forPartner
2. **Filter chips UI** - Horizontal scrollable chips with counts showing active filter
3. **useMemo filtering** - Client-side filtering of loaded attempts by player
4. **Filter counts** - Each chip shows the count of matching attempts
5. **Visual indication** - Active filter chip has primary color background

### Files changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx` - Added filter state, filtering logic, filter chips UI

### Acceptance Criteria Checklist
- [x] Filter chips: All, By Me, For Me, By Partner, For Partner
- [x] Filters update in real-time (client-side filtering)
- [x] Show count of matching attempts in each chip
- [x] Filters persist during session (state resets on screen exit)
- [x] Clear visual indication of active filter (primary color)

### Learnings
- Client-side filtering with useMemo works well for paginated data that's already loaded
- Horizontal ScrollView works well for filter chips that may overflow
- partnerId derived from coupleData.partnerIds by excluding current user

---

## 2026-01-14 - US-017 (History Filters - By Status) âœ…
Thread: https://ampcode.com/threads/T-019bbd1b-4968-7420-80ee-9b2b5a2fe5af

### What was implemented
Added status filter chips to the History screen that can be combined with player filters:

1. **StatusFilterType** - Type for filter options: all, pending, acknowledged
2. **Status filter chips UI** - Second row of filter chips below player filters
3. **Combined filtering** - useMemo filters by both player and status simultaneously
4. **Cross-filter counts** - Each filter row shows counts respecting the other filter's selection
5. **Pending highlight** - Pending chip has warning color styling when not active

### Files changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx` - Added status filter state, filtering logic, status filter chips UI, and pending styling

### Acceptance Criteria Checklist
- [x] Filter options: All, Pending, Acknowledged
- [x] Can combine with player filters (e.g., 'For Me' + 'Pending')
- [x] Show count for each status
- [x] Pending attempts highlighted or styled differently (pending chip has warning color)

### Learnings
- When combining multiple filters, calculate counts for each filter row respecting the other filter's current state
- Using separate useMemo hooks for each filter's counts makes the logic cleaner

---

## 2026-01-14 - US-019 (History Filters - By Date Range) âœ…
Thread: https://ampcode.com/threads/T-019bbd2a-d60e-70cd-8111-15ad5ce2246b

### What was implemented
Added date range filter to the History screen:

1. **DateRangeFilterType** - Type for filter options: today, last7days, last30days, alltime
2. **getDateRangeStart helper** - Calculates the start date for each filter option
3. **formatDateRange helper** - Formats the current date range for display in header
4. **Server-side Firestore query filtering** - Uses `where('createdAt', '>=', ...)` for efficient queries with timestamp index
5. **Date range filter chips UI** - Horizontal scrollable row at top of filters
6. **Date range in header** - Shows the current date range below subtitle
7. **Default to Last 7 Days** - State initialized to `last7days`

### Files changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx`
  - Added DateRangeFilterType and helper functions
  - Added dateRangeFilter state (default: 'last7days')
  - Updated fetchAttempts and loadMore to use date range in Firestore query with QueryConstraint typing
  - Added date range filter options and UI chips
  - Added dateRangeText style and filterChipDate styles
  - Updated empty state to consider date range filter

### Acceptance Criteria Checklist
- [x] Quick filters: Today, Last 7 Days, Last 30 Days, All Time
- [x] Default to Last 7 Days
- [x] Shows date range in header
- [x] Efficient Firestore query using timestamp index (uses where clause with createdAt)

### Learnings
- When building query constraints array dynamically, use `QueryConstraint[]` type annotation to allow heterogeneous constraint types (where, orderBy, limit, startAfter)
- Single field inequality + orderBy on same field doesn't require composite index in Firestore

---

## 2026-01-14 - US-020 (Analytics Dashboard - Basic Stats) âœ…
Thread: https://ampcode.com/threads/T-019bbd2e-dd3d-75a5-8930-99c74b62936f

### What was implemented
Added collapsible analytics section to the History screen showing key relationship metrics:

1. **Analytics header with toggle** - Collapsible section with ðŸ“Š icon
2. **Attempt counts by player** - Shows My Attempts, Partner's Attempts, and Total
3. **Acknowledgment stats** - Shows Acknowledged count, Pending count, and Acknowledgment rate %
4. **Gem counts** - Shows total gems earned by each player (real-time from player data)
5. **Date range aware** - Stats recalculate based on selected date range filter

### Files changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx`
  - Added usePlayerData hook import for gem counts
  - Added showAnalytics state for collapsible toggle
  - Added analyticsStats useMemo for calculating stats from loaded attempts
  - Added analytics UI section with 3 rows of stats
  - Added styles for analytics components

### Acceptance Criteria Checklist
- [x] Analytics section on History screen
- [x] Shows total attempts logged (by each player)
- [x] Shows total attempts acknowledged
- [x] Shows acknowledgment rate (acknowledged / total as percentage)
- [x] Shows total gems earned (each player)
- [x] Stats update based on active date range filter

### Learnings
- usePlayerData hook provides real-time gem counts via onSnapshot listeners
- useMemo works well for calculating derived stats from loaded data
- Collapsible sections improve UX when there's a lot of information

---
