# Ralph Progress Log
Started: 2026-01-14

## Codebase Patterns
- Firebase JS SDK used (not @react-native-firebase) for web compatibility
- User documents auto-created on anonymous auth in AuthContext
- Use `writeBatch()` for atomic multi-document operations
- Firestore security rules require `createdAt` field on user documents
- Use `getDocs` + pagination (startAfter, limit) for History-style screens (not onSnapshot)
- FlatList with onEndReached for infinite scroll pattern
- Use GemAnimationContext's `showGemAnimation(amount, x?, y?)` to trigger gem earned animations from any screen
- Use `userData?.activeCoupleId` for couple ID (not `coupleData?.id`)
- Use `{ includeMetadataChanges: true }` in onSnapshot to track pending writes for offline support
- Firestore persistence enabled via `initializeFirestore` with `persistentLocalCache`

---

## 2026-01-14 - US-001 (Fix Auth Flow) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
Fixed anonymous auth flow that was failing due to race condition:
1. AuthContext now auto-creates user document on anonymous sign-in
2. Added proper cleanup of Firestore listeners on auth state change
3. Fixed Firestore security rules for join flow

### Files changed
- `TwoCupsApp/src/context/AuthContext.tsx` - Auto-create user doc, fix listeners
- `firestore.rules` - Relaxed rules for join flow (read users, couples, players)

### Learnings
- Anonymous auth doesn't auto-create user documents - must do it manually
- Firestore security rules must allow reading partner's user doc for join flow
- Use `firebase deploy` (not `--only hosting`) for reliable deploys

---

## 2026-01-14 - US-002 (HomeScreen with Cup Visualizations) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
- CupVisualization component with fill level display
- usePlayerData hook for real-time player data from Firestore
- HomeScreen shows My Cup, Partner Cup, Collective Cup with gem counts
- Navigation buttons for Make Request, Log Attempt, Acknowledge

### Files created
- `src/components/cups/CupVisualization.tsx`
- `src/hooks/usePlayerData.ts`
- `src/hooks/index.ts`

---

## 2026-01-14 - US-003 (Log Attempt Screen) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
- LogAttemptScreen with action input, description, category picker
- Shows partner's active requests at top (for fulfillment bonus)
- Submits attempt to Firestore, awards gems
- Navigation from HomeScreen working

### Files created
- `src/screens/LogAttemptScreen.tsx`

### Status
Deployed, and works.

---

## 2026-01-14 - US-004 (Acknowledge Attempts Screen) ‚úÖ

### What was implemented
Built the Acknowledge Attempts screen where users can review and acknowledge attempts their partner logged for them:

1. **Real-time attempts list**: Fetches attempts where `forPlayerId` equals current user, ordered by `createdAt` desc
2. **Attempt cards show**: action, description, timestamp (relative), who logged it, category badge, fulfilled-request badge
3. **Filter tabs**: Pending / Done / All with counts
4. **Acknowledge button**: Calls existing `acknowledgeAttempt` API which updates:
   - `attempt.acknowledged = true`
   - Awards gems to both players (actor gets +3, recipient gets +3)
   - Updates recipient cup level (with overflow detection)
   - Updates collective cup level
5. **Visual feedback**: Alert on successful acknowledgment with gem count and cup overflow message
6. **Partner name resolution**: Fetches partner displayName from `/users/{uid}` for display

### Files created/changed
- `TwoCupsApp/src/screens/AcknowledgeScreen.tsx` (new)
- `TwoCupsApp/App.tsx`
  - Added import for AcknowledgeScreen
  - Added 'Acknowledge' to AppStackParamList
  - Wired up onNavigateToAcknowledge in HomeScreen
  - Added AppStack.Screen for Acknowledge route

### API already existed
- `acknowledgeAttempt()` in `src/services/api/actions.ts` was already implemented

### Acceptance Criteria Checklist
- [x] Shows list of pending attempts (for current user)
- [x] Each attempt shows: action, description, timestamp, who logged it
- [x] User can tap to acknowledge
- [x] Acknowledging updates: attempt.acknowledged, both gem counts, cups
- [x] Visual feedback on acknowledgment
- [x] Can filter by pending/acknowledged

### Also updated
- Unblocked US-005, US-006, US-007 in prd.json (dependencies now satisfied)

---

## 2026-01-14 - US-005 (Make Request Screen) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbb59-6af9-755a-9257-b2d828861d5a

### What was implemented
Built the Make Request screen where users can request specific actions from their partner:

1. **MakeRequestScreen component** - Form with action, description, and category inputs
2. **Uses existing `createRequest` API** - Already implemented in actions.ts
3. **Navigation wiring** - Added route to App.tsx and connected from HomeScreen

### Files created/changed
- `TwoCupsApp/src/screens/MakeRequestScreen.tsx` (new)
- `TwoCupsApp/App.tsx`
  - Added import for MakeRequestScreen
  - Added 'MakeRequest' to AppStackParamList
  - Wired up onNavigateToMakeRequest in HomeScreen
  - Added AppStack.Screen for MakeRequest route

### Acceptance Criteria Checklist
- [x] User can enter request action text
- [x] User can add optional description
- [x] User can select category
- [x] Submitting creates request doc in Firestore (uses existing createRequest API)
- [x] Request appears in partner's Log Attempt screen (already implemented in US-003)

### Learnings
- The `createRequest` API was already implemented in actions.ts
- LogAttemptScreen already queries for partner's active requests, so new requests auto-appear

---

## 2026-01-14 - US-006 (Manage Suggestions & Requests Screen) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbb5b-58a3-700e-a0b4-8e549f443a96

### What was implemented
Built the Manage Suggestions screen where users can add and manage suggestions for ways their partner can fill their cup:

1. **Suggestion type** added to types/index.ts
2. **API functions** for `createSuggestion` and `deleteSuggestion` in actions.ts
3. **ManageSuggestionsScreen** with:
   - Add suggestion form (action, description, category)
   - View suggestions grouped by category
   - Delete functionality with confirmation
   - Real-time Firestore updates
4. **LogAttemptScreen** updated to show partner's suggestions (ways to fill partner's cup)
5. **HomeScreen** updated with navigation button to ManageSuggestions

### Files created/changed
- `TwoCupsApp/src/types/index.ts` - Added Suggestion interface
- `TwoCupsApp/src/services/api/actions.ts` - Added createSuggestion, deleteSuggestion
- `TwoCupsApp/src/services/api/index.ts` - Export new functions
- `TwoCupsApp/src/screens/ManageSuggestionsScreen.tsx` (new)
- `TwoCupsApp/src/screens/LogAttemptScreen.tsx` - Show partner suggestions
- `TwoCupsApp/src/screens/HomeScreen.tsx` - Add navigation prop/button
- `TwoCupsApp/App.tsx` - Wire up ManageSuggestions route

### Acceptance Criteria Checklist
- [x] User can add new suggestions
- [x] User can view their suggestions grouped by category
- [x] User can delete suggestions
- [x] Suggestions appear in partner's Log Attempt screen

### Learnings
- Suggestions are stored at `/couples/{coupleId}/suggestions/{suggestionId}`
- Partner's suggestions queried by `byPlayerId == partnerId` in LogAttemptScreen
- Grouped display using reduce() to bucket by category

---

## 2026-01-14 - US-007 (Bottom Navigation) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbb5f-b428-77ed-8a92-53cac22a2d72

### What was implemented
Added bottom tab navigation bar to switch between main screens:

1. **Installed @react-navigation/bottom-tabs** - Tab navigation package
2. **Created SettingsScreen** - Displays profile info, couple invite code, quick actions, and sign out
3. **Refactored App.tsx** - Changed from stack-only navigation to nested tabs + stack:
   - MainTabNavigator with 4 tabs: Home, Log, Acknowledge, Settings
   - MakeRequest and ManageSuggestions remain as stack screens (modal-style)
4. **Cleaned up HomeScreen** - Removed redundant Log/Acknowledge buttons since now in tabs

### Files created/changed
- `TwoCupsApp/src/screens/SettingsScreen.tsx` (new)
- `TwoCupsApp/App.tsx` - Refactored to use bottom tabs
- `TwoCupsApp/src/screens/HomeScreen.tsx` - Removed redundant navigation buttons
- `TwoCupsApp/package.json` - Added @react-navigation/bottom-tabs dependency

### Acceptance Criteria Checklist
- [x] Tab bar at bottom of screen
- [x] Tabs: Home, Log, Acknowledge, Settings
- [x] Active tab highlighted (uses primary color)
- [x] Navigation works between all screens

### Learnings
- Bottom tabs work well with nested stack navigation for modal-style screens
- Tab icons using emoji work on both web and mobile
- MakeRequest and ManageSuggestions kept as stack screens since they're not primary tabs

---

## 2026-01-14 - US-008 (Enforce Daily Attempt Limit) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbbb6-a8c2-77bd-bb9e-5144ce28f671

### What was implemented
Enforced the 20 attempts/day limit with clear UI feedback:

1. **getDailyAttemptsInfo API** - Queries attempts created today by current user
2. **logAttempt limit check** - Throws error if limit reached before creating attempt
3. **LogAttemptScreen UI updates**:
   - Displays remaining attempts counter below header
   - Counter shows red styling when limit reached
   - Submit button disabled and text changes when at limit
   - Success alert shows remaining attempts after logging

### Files changed
- `TwoCupsApp/src/services/api/actions.ts` - Added getDailyAttemptsInfo function, added limit check to logAttempt
- `TwoCupsApp/src/services/api/index.ts` - Exported new function and type
- `TwoCupsApp/src/screens/LogAttemptScreen.tsx` - Added attempts counter UI and limit enforcement

### Acceptance Criteria Checklist
- [x] Query today's attempts by current user before allowing log
- [x] If >= 20 attempts today, show error message
- [x] Display remaining attempts count on Log Attempt screen
- [x] Counter resets at midnight (local time)

### Learnings
- Use `Timestamp.fromDate()` to convert JS Date to Firestore Timestamp for queries
- Client-side validation + server-side validation provides best UX
- Style concatenation with opacity (e.g., `colors.error + '20'`) works for semi-transparent backgrounds

---

## 2026-01-14 - US-015 (History Screen with Timeline View) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd14-8aee-751b-bfc6-59b8e59a7c94

### What was implemented
Built the History screen showing all attempts in reverse chronological order:

1. **HistoryScreen component** - Full timeline of all attempts for the couple
2. **Attempt cards show**: action, description, who logged it (by ‚Üí for), timestamp, category badge, acknowledged/pending status
3. **Pagination** - Uses Firestore getDocs with startAfter for infinite scroll (20 items per page)
4. **Pull-to-refresh** - RefreshControl for manual refresh
5. **Navigation** - Added as new "History" tab in bottom navigation (between Acknowledge and Settings)

### Files created/changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx` (new)
- `TwoCupsApp/App.tsx` - Added HistoryScreen import, HistoryTab to MainTabParamList, and tab configuration

### Acceptance Criteria Checklist
- [x] New History screen added to navigation (tab)
- [x] Displays all attempts in reverse chronological order
- [x] Each attempt card shows: action, description, who logged it, for whom, timestamp
- [x] Shows acknowledged status with visual indicator (‚úì badge or pending badge)
- [x] Paginated with infinite scroll (load 20 at a time)
- [x] Pull-to-refresh functionality

### Learnings
- For timeline/history views, use `getDocs` with pagination rather than `onSnapshot` for better control
- FlatList's `onEndReached` + `onEndReachedThreshold` handles infinite scroll nicely
- Player name resolution pattern: fetch all partner names once on mount, display "You" for current user

---

## 2026-01-14 - US-016 (History Filters - By Player) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd18-c6bb-71b9-bca6-3db6f7cd35ac

### What was implemented
Added player filter chips to the History screen:

1. **PlayerFilterType** - Type for filter options: all, byMe, forMe, byPartner, forPartner
2. **Filter chips UI** - Horizontal scrollable chips with counts showing active filter
3. **useMemo filtering** - Client-side filtering of loaded attempts by player
4. **Filter counts** - Each chip shows the count of matching attempts
5. **Visual indication** - Active filter chip has primary color background

### Files changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx` - Added filter state, filtering logic, filter chips UI

### Acceptance Criteria Checklist
- [x] Filter chips: All, By Me, For Me, By Partner, For Partner
- [x] Filters update in real-time (client-side filtering)
- [x] Show count of matching attempts in each chip
- [x] Filters persist during session (state resets on screen exit)
- [x] Clear visual indication of active filter (primary color)

### Learnings
- Client-side filtering with useMemo works well for paginated data that's already loaded
- Horizontal ScrollView works well for filter chips that may overflow
- partnerId derived from coupleData.partnerIds by excluding current user

---

## 2026-01-14 - US-017 (History Filters - By Status) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd1b-4968-7420-80ee-9b2b5a2fe5af

### What was implemented
Added status filter chips to the History screen that can be combined with player filters:

1. **StatusFilterType** - Type for filter options: all, pending, acknowledged
2. **Status filter chips UI** - Second row of filter chips below player filters
3. **Combined filtering** - useMemo filters by both player and status simultaneously
4. **Cross-filter counts** - Each filter row shows counts respecting the other filter's selection
5. **Pending highlight** - Pending chip has warning color styling when not active

### Files changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx` - Added status filter state, filtering logic, status filter chips UI, and pending styling

### Acceptance Criteria Checklist
- [x] Filter options: All, Pending, Acknowledged
- [x] Can combine with player filters (e.g., 'For Me' + 'Pending')
- [x] Show count for each status
- [x] Pending attempts highlighted or styled differently (pending chip has warning color)

### Learnings
- When combining multiple filters, calculate counts for each filter row respecting the other filter's current state
- Using separate useMemo hooks for each filter's counts makes the logic cleaner

---

## 2026-01-14 - US-019 (History Filters - By Date Range) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd2a-d60e-70cd-8111-15ad5ce2246b

### What was implemented
Added date range filter to the History screen:

1. **DateRangeFilterType** - Type for filter options: today, last7days, last30days, alltime
2. **getDateRangeStart helper** - Calculates the start date for each filter option
3. **formatDateRange helper** - Formats the current date range for display in header
4. **Server-side Firestore query filtering** - Uses `where('createdAt', '>=', ...)` for efficient queries with timestamp index
5. **Date range filter chips UI** - Horizontal scrollable row at top of filters
6. **Date range in header** - Shows the current date range below subtitle
7. **Default to Last 7 Days** - State initialized to `last7days`

### Files changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx`
  - Added DateRangeFilterType and helper functions
  - Added dateRangeFilter state (default: 'last7days')
  - Updated fetchAttempts and loadMore to use date range in Firestore query with QueryConstraint typing
  - Added date range filter options and UI chips
  - Added dateRangeText style and filterChipDate styles
  - Updated empty state to consider date range filter

### Acceptance Criteria Checklist
- [x] Quick filters: Today, Last 7 Days, Last 30 Days, All Time
- [x] Default to Last 7 Days
- [x] Shows date range in header
- [x] Efficient Firestore query using timestamp index (uses where clause with createdAt)

### Learnings
- When building query constraints array dynamically, use `QueryConstraint[]` type annotation to allow heterogeneous constraint types (where, orderBy, limit, startAfter)
- Single field inequality + orderBy on same field doesn't require composite index in Firestore

---

## 2026-01-14 - US-020 (Analytics Dashboard - Basic Stats) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd2e-dd3d-75a5-8930-99c74b62936f

### What was implemented
Added collapsible analytics section to the History screen showing key relationship metrics:

1. **Analytics header with toggle** - Collapsible section with üìä icon
2. **Attempt counts by player** - Shows My Attempts, Partner's Attempts, and Total
3. **Acknowledgment stats** - Shows Acknowledged count, Pending count, and Acknowledgment rate %
4. **Gem counts** - Shows total gems earned by each player (real-time from player data)
5. **Date range aware** - Stats recalculate based on selected date range filter

### Files changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx`
  - Added usePlayerData hook import for gem counts
  - Added showAnalytics state for collapsible toggle
  - Added analyticsStats useMemo for calculating stats from loaded attempts
  - Added analytics UI section with 3 rows of stats
  - Added styles for analytics components

### Acceptance Criteria Checklist
- [x] Analytics section on History screen
- [x] Shows total attempts logged (by each player)
- [x] Shows total attempts acknowledged
- [x] Shows acknowledgment rate (acknowledged / total as percentage)
- [x] Shows total gems earned (each player)
- [x] Stats update based on active date range filter

### Learnings
- usePlayerData hook provides real-time gem counts via onSnapshot listeners
- useMemo works well for calculating derived stats from loaded data
- Collapsible sections improve UX when there's a lot of information

---

## 2026-01-14 - US-021 (Analytics - Category Breakdown) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd31-d552-76be-9efe-9a47e450d312

### What was implemented
Added collapsible category breakdown section to the History screen:

1. **Separate collapsible section** - "üìä Category Breakdown" below main analytics, collapsed by default
2. **Two breakdowns** - "Attempts I Logged" and "Attempts For Me" with separate stats
3. **Category list sorted by frequency** - Most used categories appear first
4. **Count and percentage** - Each category shows count and percentage of total
5. **Visual progress bars** - Horizontal bars showing relative usage (primary color for "by me", success color for "for me")

### Files changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx`
  - Added showCategoryBreakdown state
  - Added categoryBreakdownStats useMemo with calculateBreakdown helper
  - Added Category Breakdown UI section with two subsections
  - Added styles: categoryBreakdownContainer, breakdownSection, breakdownSectionTitle, breakdownEmpty, breakdownRow, breakdownLabelContainer, breakdownLabel, breakdownCount, breakdownBarContainer, breakdownBar

### Acceptance Criteria Checklist
- [x] List of categories with attempt counts
- [x] Sorted by frequency (most used first)
- [x] Shows percentage of total for each category
- [x] Visual bar or indicator showing relative usage
- [x] Separate breakdown for 'attempts I logged' vs 'attempts for me'

### Learnings
- Using Object.entries() with sort() is clean pattern for frequency-sorted lists
- Nested type definitions inside useMemo keep types local and readable

---

## 2026-01-14 - US-022 (Analytics - Request Stats) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd34-a6ec-73ab-ade8-098c3070740f

### What was implemented
Added collapsible Request Stats section to the History screen showing request fulfillment analytics:

1. **Fetch requests data** - New useEffect fetches all requests from Firestore with date range filter
2. **Request counts by player** - Shows My Requests, Partner's Requests, and Total
3. **Fulfillment stats** - Shows Fulfilled count, Active count, and Fulfillment rate %
4. **Average time to fulfill** - Calculates and displays avg time (in hours or days) for fulfilled requests
5. **Most requested categories** - Bar chart showing top 5 most requested categories with counts and percentages
6. **Date range aware** - Stats recalculate based on selected date range filter

### Files changed
- `TwoCupsApp/src/screens/HistoryScreen.tsx`
  - Added Request import from types
  - Added showRequestStats and requests state
  - Added fetchRequests useEffect with date range filtering
  - Added requestStats useMemo for calculating stats
  - Added Request Stats UI section with 3 stat rows and category breakdown

### Acceptance Criteria Checklist
- [x] Total requests made (each player)
- [x] Total requests fulfilled
- [x] Fulfillment rate percentage
- [x] Average time to fulfill request (if data available)
- [x] Most requested categories

### Learnings
- Request documents have fulfilledAt timestamp when fulfilled, useful for calculating response time
- Reused existing breakdownSection styles for consistent category list display
- Using colors.primaryLight for request category bars to differentiate from attempt category bars

---

## 2026-01-14 - US-031 (Gem Earned Animation) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd57-8ff9-7705-be91-35b30f705ab6

### What was implemented
Built animated gem particles that float upward when gems are earned:

1. **GemAnimation component** - Renders animated gem particles with:
   - Scale-in spring animation on spawn
   - Float upward with translateY animation
   - Fade out as gems rise
   - Subtle rotation for visual interest
   - "+N" badge showing gem amount

2. **GemAnimationContext** - Context provider for triggering animations from anywhere in app:
   - `showGemAnimation(amount, x?, y?)` function
   - Renders GemAnimation as overlay on top of all content
   - Auto-hides on animation complete

3. **Integration with LogAttemptScreen** - Shows gem animation when:
   - Logging attempt: +1 gem animation
   - Fulfilling request: +2 gems animation

4. **Integration with AcknowledgeScreen** - Shows +3 gem animation when acknowledging

### Files created/changed
- `TwoCupsApp/src/components/common/GemAnimation.tsx` (new)
- `TwoCupsApp/src/context/GemAnimationContext.tsx` (new)
- `TwoCupsApp/src/components/common/index.ts` - Added export
- `TwoCupsApp/App.tsx` - Added GemAnimationProvider
- `TwoCupsApp/src/screens/LogAttemptScreen.tsx` - Trigger gem animation on success
- `TwoCupsApp/src/screens/AcknowledgeScreen.tsx` - Trigger gem animation on success

### Acceptance Criteria Checklist
- [x] When logging attempt: show +1 or +2 gem animation
- [x] When acknowledging: show +3 gem animation
- [x] Gems float upward and fade out
- [x] Animation plays near the action that triggered it (center of screen)
- [x] Animation duration ~1-2 seconds (1.2s float + fade)
- [x] Different gem colors for different amounts (optional - using gem emoji)

### Learnings
- React Native Animated API works well for particle effects without needing Reanimated
- Using a Context for animations allows triggering from anywhere without prop drilling
- Spring animations with high tension give a nice "pop" effect on spawn
- Stagger delays (100ms) between particles adds visual interest

---

## 2026-01-14 - US-032 (Gem Counter Component Redesign) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd5c-286b-7504-9216-e2461c188769

### What was implemented
Built a redesigned GemCounter component with enhanced visuals and animations:

1. **GemCounter component** - Prominent gem display at top of HomeScreen
   - Shows both players' gem counts side-by-side with "Gem Treasury" header
   - "Together" total row showing combined gems
   - Purple gem-themed styling with border and shadow

2. **AnimatedGemDisplay sub-component** - Per-player gem counter with:
   - Count-up animation when value changes (interpolates from old to new value)
   - Scale "pop" effect (1.2x scale then spring back) on change
   - Active glow pulse that fades when gems change
   - Continuous subtle sparkle animation (pulsing opacity behind gem icon)

3. **Responsive sizing** - Detects small screens (<360px) and adjusts padding

4. **HomeScreen integration** - Added GemCounter below header, removed gemCount from CupVisualization props

### Files created/changed
- `TwoCupsApp/src/components/common/GemCounter.tsx` (new)
- `TwoCupsApp/src/components/common/index.ts` - Export GemCounter
- `TwoCupsApp/src/screens/HomeScreen.tsx` - Added GemCounter, removed gemCount from cups

### Acceptance Criteria Checklist
- [x] Gem icon with count displayed prominently
- [x] Counter animates when value changes (count up effect)
- [x] Shows both players' gem counts clearly
- [x] Gem icon has subtle sparkle or glow effect (continuous pulsing animation)
- [x] Responsive sizing for different screen sizes

### Learnings
- Animated.parallel() combines multiple animations (count, scale, glow) cleanly
- Animated.loop() for continuous sparkle effect without manual restart
- useRef for previousCount to detect value changes and trigger animations
- animatedValue.addListener() for updating display count during animation

---

## 2026-01-14 - US-033 (Gem Summary in Toast Notifications) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd5f-a165-7229-9645-1ee4bae86528

### What was implemented
Enhanced toast notifications to prominently display gem rewards:

1. **Extended ToastContext** - Added GemReward interface with amount, isBonus, and partnerAmount fields
   - Updated showToast, showSuccess, showCelebration to accept optional gemReward parameter

2. **Enhanced Toast component** - Added gem-specific styling and display:
   - GemRewardDisplay sub-component shows gem icon + amount prominently
   - Bonus badge (green "BONUS" tag) for request fulfillment
   - Partner gems row showing "+X to partner" for acknowledgments
   - Purple gem-themed toast styling when gem reward present

3. **LogAttemptScreen integration**:
   - Log attempt toast shows "Attempt logged!" with gem icon + amount
   - Request fulfillment toast shows "Request fulfilled!" with BONUS badge

4. **AcknowledgeScreen integration**:
   - Acknowledge toast shows "+3 gems to you, +3 gems to partner"
   - Updated celebration messages to show per-player gem amounts

### Files changed
- `TwoCupsApp/src/context/ToastContext.tsx` - Added GemReward interface and updated toast functions
- `TwoCupsApp/src/components/common/Toast.tsx` - Added GemRewardDisplay component and gem styling
- `TwoCupsApp/src/screens/LogAttemptScreen.tsx` - Pass gem reward info to toast
- `TwoCupsApp/src/screens/AcknowledgeScreen.tsx` - Pass gem reward with partner amount to toast

### Acceptance Criteria Checklist
- [x] Log attempt toast shows gem icon + amount earned
- [x] Request fulfillment toast shows bonus gem indicator
- [x] Acknowledge toast shows '+3 gems to you, +3 gems to partner'
- [x] Gem icon in toast matches app gem design (uses üíé emoji)
- [x] Toast styling emphasizes the gem reward (purple gem-themed border and background)

### Learnings
- Extending existing context interfaces is cleaner than creating new specialized hooks
- Optional parameters with default undefined allow backward compatibility

---

## 2026-01-14 - US-034 (Daily Gem Earnings Summary) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd62-cd97-7344-b4ec-b3d83e4b748a

### What was implemented
Added daily gem earnings summary to the GemCounter component on HomeScreen:

1. **getDailyGemEarnings API** - Queries today's attempts and acknowledgments to calculate gems earned:
   - Logging gems: base 1 per attempt + 2 bonus for fulfilled requests
   - Acknowledgment gems: 3 when partner acknowledges your attempts + 3 when you acknowledge partner's attempts

2. **GemCounter updates**:
   - "Today: +X gems" display below total gem count
   - Breakdown showing "X from logging, Y from acknowledgments" when gems earned
   - Encouraging messages based on daily progress:
     - 0 gems: "Log an attempt or acknowledge your partner to earn gems!"
     - 1-4 gems: "Nice start! Every gem counts!"
     - 5-9 gems: "Great job! You're building something special!"
     - 10-19 gems: "Fantastic progress! Keep it up!"
     - 20+ gems: "Amazing day! You're on fire!"
   - Auto-refreshes every 30 seconds and when myGems changes

### Files created/changed
- `TwoCupsApp/src/services/api/actions.ts` - Added DailyGemEarnings type and getDailyGemEarnings function
- `TwoCupsApp/src/services/api/index.ts` - Exported new function and type
- `TwoCupsApp/src/components/common/GemCounter.tsx` - Added daily earnings section with breakdown and encouraging messages

### Acceptance Criteria Checklist
- [x] Display 'Today: +X gems' below total gem count
- [x] Resets at midnight local time (uses startOfDay in query)
- [x] Shows breakdown: 'X from logging, Y from acknowledgments' (when gems > 0)
- [x] Encouraging message if gems earned today (tiered messages)
- [x] Different message if no gems yet today

### Learnings
- Use userData.activeCoupleId instead of coupleData.id (Couple type doesn't include id field)
- Querying acknowledgedAt >= startOfDay captures both given and received acknowledgment gems

---

## 2026-01-14 - US-035 (Gem Milestone Celebrations) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd66-85b1-7286-98ab-91eb9008c143

### What was implemented
Built milestone celebration system that shows a modal when users reach gem milestones:

1. **MilestoneCelebrationContext** - Context provider for detecting and displaying milestone celebrations:
   - Checks when gem count crosses milestone thresholds (100, 250, 500, 1000, 2500, 5000, 10000)
   - Tracks achieved milestones in player document to prevent re-triggering
   - Uses Firestore `arrayUnion` to persist achieved milestones

2. **CelebrationModal component** - Animated celebration overlay:
   - Spring animation on modal appearance
   - Pulsing sparkle animations around the modal
   - Milestone-specific badge emoji (üíé, ‚ú®, üèÜ, üëë, üåü, üí´, üéÜ)
   - Milestone-specific congratulation messages
   - Purple gem-themed styling with glow effects

3. **Player type updated** - Added optional `achievedMilestones: number[]` field

4. **HomeScreen integration** - Monitors gem count changes and triggers milestone check

### Files created/changed
- `TwoCupsApp/src/context/MilestoneCelebrationContext.tsx` (new)
- `TwoCupsApp/src/types/index.ts` - Added achievedMilestones to Player interface
- `TwoCupsApp/src/hooks/usePlayerData.ts` - Include achievedMilestones in PlayerWithId
- `TwoCupsApp/src/screens/HomeScreen.tsx` - Added milestone checking on gem changes
- `TwoCupsApp/App.tsx` - Added MilestoneCelebrationProvider

### Acceptance Criteria Checklist
- [x] Detect when gem count crosses milestone threshold
- [x] Show celebration modal/overlay for milestones
- [x] Milestones: 100, 250, 500, 1000, 2500, 5000, 10000
- [x] Celebration includes milestone badge/icon
- [x] Message acknowledges achievement (e.g., '500 gems! You're crushing it!')
- [x] Only triggers once per milestone (track in user doc via achievedMilestones array)

### Learnings
- Use `arrayUnion` from Firestore to atomically add milestones without read-modify-write
- Track previous gem count with useRef to only trigger on increases
- Spring animations with high tension give satisfying "pop" effects for celebrations
- Modal z-index handled automatically by React Native Modal component

---

## 2026-01-14 - US-036 (Gem Leaderboard - Couple View) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd6d-2fc3-7656-b16e-619e96ead8f7

### What was implemented
Built a fun comparison view showing gem earnings between partners:

1. **GemLeaderboard component** - Visual comparison of gem counts between partners:
   - Visual bar chart with animated bars comparing gem counts
   - "Gem Champion" crown label (üëë) for whoever is ahead
   - Playful, encouraging messages based on standings
   - Toggle between "This Week" and "All Time" views

2. **getWeeklyGemStats API** - Queries attempts from current week to calculate:
   - Gems from logging attempts (base 1 + 2 bonus for fulfilled requests)
   - Gems from acknowledgments (given and received)
   - Calculates for both players in parallel

3. **HomeScreen integration** - GemLeaderboard appears below GemCounter

### Files created/changed
- `TwoCupsApp/src/components/common/GemLeaderboard.tsx` (new)
- `TwoCupsApp/src/components/common/index.ts` - Export GemLeaderboard
- `TwoCupsApp/src/screens/HomeScreen.tsx` - Added GemLeaderboard component
- `TwoCupsApp/src/services/api/actions.ts` - Added getWeeklyGemStats function
- `TwoCupsApp/src/services/api/index.ts` - Exported new function and type

### Acceptance Criteria Checklist
- [x] Section on HomeScreen showing both partners' gems
- [x] Visual bar chart comparing gem counts (animated bars)
- [x] Playful messaging (not competitive, encouraging)
- [x] Shows who's 'ahead' with fun label ('üëë Gem Champion')
- [x] Option to view weekly or all-time comparison (toggle buttons)

### Learnings
- usePlayerData hook exposes player IDs via `odI` property (typo for `id`)
- Week starts on Monday (ISO standard) - dayOfWeek calculation subtracts appropriate days
- Animated.interpolate for percentage-based widths requires useNativeDriver: false

---

## 2026-01-14 - US-037 (Gem History Log) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbd73-2a40-71f1-82f3-3485043667bc

### What was implemented
Built a detailed gem history log showing all gem transactions:

1. **GemHistoryScreen component** - Paginated FlatList showing gem earning events:
   - Queries attempts where user is either `byPlayerId` or `forPlayerId`
   - Processes attempts into gem entries: logged attempt (+1), fulfilled request bonus (+2), acknowledgments (+3)
   - Each entry shows: amount, reason icon, timestamp, related action
   - Running total displayed at top
   - Infinite scroll with 20 items per page

2. **Navigation access**:
   - From Settings ‚Üí "üíé Gem History" button
   - From HomeScreen ‚Üí Tap the GemCounter component
   - GemCounter shows "Tap for gem history" hint when tappable

3. **Visual design**:
   - Gem-themed purple accents
   - Color-coded reason badges (primary for logging, success for fulfillment, gem color for acknowledgments)
   - Icon badges for each transaction type (üíù logged, üéØ fulfilled, ‚úÖ you acknowledged, ü§ù partner acknowledged)

### Files created/changed
- `TwoCupsApp/src/screens/GemHistoryScreen.tsx` (new)
- `TwoCupsApp/App.tsx` - Added GemHistory route and navigation wiring
- `TwoCupsApp/src/screens/SettingsScreen.tsx` - Added Gem History navigation button
- `TwoCupsApp/src/screens/HomeScreen.tsx` - Added onNavigateToGemHistory prop
- `TwoCupsApp/src/components/common/GemCounter.tsx` - Made tappable with onPress prop

### Acceptance Criteria Checklist
- [x] Accessible from Settings or gem counter tap
- [x] Shows each gem earning event with timestamp
- [x] Entry shows: amount, reason (logged attempt, acknowledged, request fulfilled)
- [x] Links to the relevant attempt if applicable (shows action in entry)
- [x] Paginated list (load 20 at a time)
- [x] Running total displayed

### Learnings
- Firestore `or()` query allows combining `byPlayerId` and `forPlayerId` filters
- Process attempts into multiple gem entries (one attempt can generate 1-3 gem entries)
- TouchableOpacity wrapper with conditional rendering works well for making components optionally tappable
- EmptyState component uses `subtitle` not `message` prop

---

## 2026-01-14 - US-050 & US-051 (Firestore Offline Persistence & Offline Mode Indicator) ‚úÖ
Thread: https://ampcode.com/threads/T-019bbdb5-cc03-7248-9532-78c4c5610307

### What was implemented
Enabled Firestore offline persistence and added visual indicators for offline mode:

1. **Firestore persistence** - Updated firebase config to use `initializeFirestore` with `persistentLocalCache` and `persistentMultipleTabManager` for multi-tab IndexedDB persistence

2. **NetworkContext** - New context provider for:
   - Tracking online/offline status via browser events (navigator.onLine, online/offline events)
   - Monitoring pending Firestore writes via `includeMetadataChanges` on snapshots
   - Showing toast notifications when coming back online ("Back online!")
   - Showing toast when pending writes sync ("All changes synced!")

3. **OfflineBanner component** - Animated banner at top of screen showing:
   - "üì° You're offline ‚Ä¢ Data will sync when connected" when offline
   - "üì° Offline ‚Ä¢ X action(s) pending" when offline with pending writes
   - "‚è≥ Syncing X action(s)..." when online but writes pending
   - Auto-dismisses when back online with all synced
   - Pulsing animation when offline

4. **App integration** - NetworkProvider wraps app, OfflineBanner shown above navigation

### Files created/changed
- `TwoCupsApp/src/services/firebase/config.ts` - Added persistent cache initialization
- `TwoCupsApp/src/context/NetworkContext.tsx` (new) - Network status and pending writes tracking
- `TwoCupsApp/src/components/common/OfflineBanner.tsx` (new) - Animated offline indicator
- `TwoCupsApp/src/components/common/index.ts` - Export OfflineBanner
- `TwoCupsApp/App.tsx` - Added NetworkProvider and OfflineBanner

### Acceptance Criteria Checklist (US-050)
- [x] Enable Firestore persistence in firebase config
- [x] App loads cached data when offline (automatic with persistence)
- [x] User can view HomeScreen, history while offline
- [x] Pending writes sync when back online (automatic with Firestore)
- [x] Visual indicator when app is offline
- [x] Queue actions taken offline and sync later (automatic with Firestore)

### Acceptance Criteria Checklist (US-051)
- [x] Banner or icon shows when device is offline
- [x] Shows count of pending actions to sync
- [x] Banner dismisses automatically when back online
- [x] Toast notification when sync completes
- [x] Non-intrusive but visible placement

### Learnings
- Firebase JS SDK v9.8+ uses `initializeFirestore` with `persistentLocalCache` instead of deprecated `enableIndexedDbPersistence`
- Use `persistentMultipleTabManager()` for multi-tab support
- `snapshot.metadata.hasPendingWrites` indicates documents with local changes not yet synced
- Use `{ includeMetadataChanges: true }` in onSnapshot to receive metadata change events
- Use `userData?.activeCoupleId` instead of `coupleData?.id` (Couple type doesn't include id)

---
