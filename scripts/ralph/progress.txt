# Ralph Progress Log
Started: 2026-01-14

## Codebase Patterns
- Firebase JS SDK used (not @react-native-firebase) for web compatibility
- User documents auto-created on anonymous auth in AuthContext
- Use `writeBatch()` for atomic multi-document operations
- Firestore security rules require `createdAt` field on user documents

---

## 2026-01-14 - US-001 (Fix Auth Flow) ✅
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
Fixed anonymous auth flow that was failing due to race condition:
1. AuthContext now auto-creates user document on anonymous sign-in
2. Added proper cleanup of Firestore listeners on auth state change
3. Fixed Firestore security rules for join flow

### Files changed
- `TwoCupsApp/src/context/AuthContext.tsx` - Auto-create user doc, fix listeners
- `firestore.rules` - Relaxed rules for join flow (read users, couples, players)

### Learnings
- Anonymous auth doesn't auto-create user documents - must do it manually
- Firestore security rules must allow reading partner's user doc for join flow
- Use `firebase deploy` (not `--only hosting`) for reliable deploys

---

## 2026-01-14 - US-002 (HomeScreen with Cup Visualizations) ✅
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
- CupVisualization component with fill level display
- usePlayerData hook for real-time player data from Firestore
- HomeScreen shows My Cup, Partner Cup, Collective Cup with gem counts
- Navigation buttons for Make Request, Log Attempt, Acknowledge

### Files created
- `src/components/cups/CupVisualization.tsx`
- `src/hooks/usePlayerData.ts`
- `src/hooks/index.ts`

---

## 2026-01-14 - US-003 (Log Attempt Screen) ✅
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
- LogAttemptScreen with action input, description, category picker
- Shows partner's active requests at top (for fulfillment bonus)
- Submits attempt to Firestore, awards gems
- Navigation from HomeScreen working

### Files created
- `src/screens/LogAttemptScreen.tsx`

### Status
Deployed, and works.

---

## 2026-01-14 - US-004 (Acknowledge Attempts Screen) ✅

### What was implemented
Built the Acknowledge Attempts screen where users can review and acknowledge attempts their partner logged for them:

1. **Real-time attempts list**: Fetches attempts where `forPlayerId` equals current user, ordered by `createdAt` desc
2. **Attempt cards show**: action, description, timestamp (relative), who logged it, category badge, fulfilled-request badge
3. **Filter tabs**: Pending / Done / All with counts
4. **Acknowledge button**: Calls existing `acknowledgeAttempt` API which updates:
   - `attempt.acknowledged = true`
   - Awards gems to both players (actor gets +3, recipient gets +3)
   - Updates recipient cup level (with overflow detection)
   - Updates collective cup level
5. **Visual feedback**: Alert on successful acknowledgment with gem count and cup overflow message
6. **Partner name resolution**: Fetches partner displayName from `/users/{uid}` for display

### Files created/changed
- `TwoCupsApp/src/screens/AcknowledgeScreen.tsx` (new)
- `TwoCupsApp/App.tsx`
  - Added import for AcknowledgeScreen
  - Added 'Acknowledge' to AppStackParamList
  - Wired up onNavigateToAcknowledge in HomeScreen
  - Added AppStack.Screen for Acknowledge route

### API already existed
- `acknowledgeAttempt()` in `src/services/api/actions.ts` was already implemented

### Acceptance Criteria Checklist
- [x] Shows list of pending attempts (for current user)
- [x] Each attempt shows: action, description, timestamp, who logged it
- [x] User can tap to acknowledge
- [x] Acknowledging updates: attempt.acknowledged, both gem counts, cups
- [x] Visual feedback on acknowledgment
- [x] Can filter by pending/acknowledged

### Also updated
- Unblocked US-005, US-006, US-007 in prd.json (dependencies now satisfied)

---

## 2026-01-14 - US-005 (Make Request Screen) ✅
Thread: https://ampcode.com/threads/T-019bbb59-6af9-755a-9257-b2d828861d5a

### What was implemented
Built the Make Request screen where users can request specific actions from their partner:

1. **MakeRequestScreen component** - Form with action, description, and category inputs
2. **Uses existing `createRequest` API** - Already implemented in actions.ts
3. **Navigation wiring** - Added route to App.tsx and connected from HomeScreen

### Files created/changed
- `TwoCupsApp/src/screens/MakeRequestScreen.tsx` (new)
- `TwoCupsApp/App.tsx`
  - Added import for MakeRequestScreen
  - Added 'MakeRequest' to AppStackParamList
  - Wired up onNavigateToMakeRequest in HomeScreen
  - Added AppStack.Screen for MakeRequest route

### Acceptance Criteria Checklist
- [x] User can enter request action text
- [x] User can add optional description
- [x] User can select category
- [x] Submitting creates request doc in Firestore (uses existing createRequest API)
- [x] Request appears in partner's Log Attempt screen (already implemented in US-003)

### Learnings
- The `createRequest` API was already implemented in actions.ts
- LogAttemptScreen already queries for partner's active requests, so new requests auto-appear

---
