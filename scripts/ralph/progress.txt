# Ralph Progress Log
Started: 2026-01-14

## Codebase Patterns
- Firebase JS SDK used (not @react-native-firebase) for web compatibility
- User documents auto-created on anonymous auth in AuthContext
- Use `writeBatch()` for atomic multi-document operations
- Firestore security rules require `createdAt` field on user documents

---

## 2026-01-14 - US-001 (Fix Auth Flow) ✅
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
Fixed anonymous auth flow that was failing due to race condition:
1. AuthContext now auto-creates user document on anonymous sign-in
2. Added proper cleanup of Firestore listeners on auth state change
3. Fixed Firestore security rules for join flow

### Files changed
- `TwoCupsApp/src/context/AuthContext.tsx` - Auto-create user doc, fix listeners
- `firestore.rules` - Relaxed rules for join flow (read users, couples, players)

### Learnings
- Anonymous auth doesn't auto-create user documents - must do it manually
- Firestore security rules must allow reading partner's user doc for join flow
- Use `firebase deploy` (not `--only hosting`) for reliable deploys

---

## 2026-01-14 - US-002 (HomeScreen with Cup Visualizations) ✅
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
- CupVisualization component with fill level display
- usePlayerData hook for real-time player data from Firestore
- HomeScreen shows My Cup, Partner Cup, Collective Cup with gem counts
- Navigation buttons for Make Request, Log Attempt, Acknowledge

### Files created
- `src/components/cups/CupVisualization.tsx`
- `src/hooks/usePlayerData.ts`
- `src/hooks/index.ts`

---

## 2026-01-14 - US-003 (Log Attempt Screen) ✅
Thread: https://ampcode.com/threads/T-019bbae3-4db0-7208-aa9f-ea7393030e39

### What was implemented
- LogAttemptScreen with action input, description, category picker
- Shows partner's active requests at top (for fulfillment bonus)
- Submits attempt to Firestore, awards gems
- Navigation from HomeScreen working

### Files created
- `src/screens/LogAttemptScreen.tsx`

### Status
Deployed, and works.

---

## 2026-01-14 - US-004 (Acknowledge Attempts Screen) ✅

### What was implemented
Built the Acknowledge Attempts screen where users can review and acknowledge attempts their partner logged for them:

1. **Real-time attempts list**: Fetches attempts where `forPlayerId` equals current user, ordered by `createdAt` desc
2. **Attempt cards show**: action, description, timestamp (relative), who logged it, category badge, fulfilled-request badge
3. **Filter tabs**: Pending / Done / All with counts
4. **Acknowledge button**: Calls existing `acknowledgeAttempt` API which updates:
   - `attempt.acknowledged = true`
   - Awards gems to both players (actor gets +3, recipient gets +3)
   - Updates recipient cup level (with overflow detection)
   - Updates collective cup level
5. **Visual feedback**: Alert on successful acknowledgment with gem count and cup overflow message
6. **Partner name resolution**: Fetches partner displayName from `/users/{uid}` for display

### Files created/changed
- `TwoCupsApp/src/screens/AcknowledgeScreen.tsx` (new)
- `TwoCupsApp/App.tsx`
  - Added import for AcknowledgeScreen
  - Added 'Acknowledge' to AppStackParamList
  - Wired up onNavigateToAcknowledge in HomeScreen
  - Added AppStack.Screen for Acknowledge route

### API already existed
- `acknowledgeAttempt()` in `src/services/api/actions.ts` was already implemented

### Acceptance Criteria Checklist
- [x] Shows list of pending attempts (for current user)
- [x] Each attempt shows: action, description, timestamp, who logged it
- [x] User can tap to acknowledge
- [x] Acknowledging updates: attempt.acknowledged, both gem counts, cups
- [x] Visual feedback on acknowledgment
- [x] Can filter by pending/acknowledged

### Also updated
- Unblocked US-005, US-006, US-007 in prd.json (dependencies now satisfied)

---

## 2026-01-14 - US-005 (Make Request Screen) ✅
Thread: https://ampcode.com/threads/T-019bbb59-6af9-755a-9257-b2d828861d5a

### What was implemented
Built the Make Request screen where users can request specific actions from their partner:

1. **MakeRequestScreen component** - Form with action, description, and category inputs
2. **Uses existing `createRequest` API** - Already implemented in actions.ts
3. **Navigation wiring** - Added route to App.tsx and connected from HomeScreen

### Files created/changed
- `TwoCupsApp/src/screens/MakeRequestScreen.tsx` (new)
- `TwoCupsApp/App.tsx`
  - Added import for MakeRequestScreen
  - Added 'MakeRequest' to AppStackParamList
  - Wired up onNavigateToMakeRequest in HomeScreen
  - Added AppStack.Screen for MakeRequest route

### Acceptance Criteria Checklist
- [x] User can enter request action text
- [x] User can add optional description
- [x] User can select category
- [x] Submitting creates request doc in Firestore (uses existing createRequest API)
- [x] Request appears in partner's Log Attempt screen (already implemented in US-003)

### Learnings
- The `createRequest` API was already implemented in actions.ts
- LogAttemptScreen already queries for partner's active requests, so new requests auto-appear

---

## 2026-01-14 - US-006 (Manage Suggestions & Requests Screen) ✅
Thread: https://ampcode.com/threads/T-019bbb5b-58a3-700e-a0b4-8e549f443a96

### What was implemented
Built the Manage Suggestions screen where users can add and manage suggestions for ways their partner can fill their cup:

1. **Suggestion type** added to types/index.ts
2. **API functions** for `createSuggestion` and `deleteSuggestion` in actions.ts
3. **ManageSuggestionsScreen** with:
   - Add suggestion form (action, description, category)
   - View suggestions grouped by category
   - Delete functionality with confirmation
   - Real-time Firestore updates
4. **LogAttemptScreen** updated to show partner's suggestions (ways to fill partner's cup)
5. **HomeScreen** updated with navigation button to ManageSuggestions

### Files created/changed
- `TwoCupsApp/src/types/index.ts` - Added Suggestion interface
- `TwoCupsApp/src/services/api/actions.ts` - Added createSuggestion, deleteSuggestion
- `TwoCupsApp/src/services/api/index.ts` - Export new functions
- `TwoCupsApp/src/screens/ManageSuggestionsScreen.tsx` (new)
- `TwoCupsApp/src/screens/LogAttemptScreen.tsx` - Show partner suggestions
- `TwoCupsApp/src/screens/HomeScreen.tsx` - Add navigation prop/button
- `TwoCupsApp/App.tsx` - Wire up ManageSuggestions route

### Acceptance Criteria Checklist
- [x] User can add new suggestions
- [x] User can view their suggestions grouped by category
- [x] User can delete suggestions
- [x] Suggestions appear in partner's Log Attempt screen

### Learnings
- Suggestions are stored at `/couples/{coupleId}/suggestions/{suggestionId}`
- Partner's suggestions queried by `byPlayerId == partnerId` in LogAttemptScreen
- Grouped display using reduce() to bucket by category

---

## 2026-01-14 - US-007 (Bottom Navigation) ✅
Thread: https://ampcode.com/threads/T-019bbb5f-b428-77ed-8a92-53cac22a2d72

### What was implemented
Added bottom tab navigation bar to switch between main screens:

1. **Installed @react-navigation/bottom-tabs** - Tab navigation package
2. **Created SettingsScreen** - Displays profile info, couple invite code, quick actions, and sign out
3. **Refactored App.tsx** - Changed from stack-only navigation to nested tabs + stack:
   - MainTabNavigator with 4 tabs: Home, Log, Acknowledge, Settings
   - MakeRequest and ManageSuggestions remain as stack screens (modal-style)
4. **Cleaned up HomeScreen** - Removed redundant Log/Acknowledge buttons since now in tabs

### Files created/changed
- `TwoCupsApp/src/screens/SettingsScreen.tsx` (new)
- `TwoCupsApp/App.tsx` - Refactored to use bottom tabs
- `TwoCupsApp/src/screens/HomeScreen.tsx` - Removed redundant navigation buttons
- `TwoCupsApp/package.json` - Added @react-navigation/bottom-tabs dependency

### Acceptance Criteria Checklist
- [x] Tab bar at bottom of screen
- [x] Tabs: Home, Log, Acknowledge, Settings
- [x] Active tab highlighted (uses primary color)
- [x] Navigation works between all screens

### Learnings
- Bottom tabs work well with nested stack navigation for modal-style screens
- Tab icons using emoji work on both web and mobile
- MakeRequest and ManageSuggestions kept as stack screens since they're not primary tabs

---

## 2026-01-14 - US-008 (Enforce Daily Attempt Limit) ✅
Thread: https://ampcode.com/threads/T-019bbbb6-a8c2-77bd-bb9e-5144ce28f671

### What was implemented
Enforced the 20 attempts/day limit with clear UI feedback:

1. **getDailyAttemptsInfo API** - Queries attempts created today by current user
2. **logAttempt limit check** - Throws error if limit reached before creating attempt
3. **LogAttemptScreen UI updates**:
   - Displays remaining attempts counter below header
   - Counter shows red styling when limit reached
   - Submit button disabled and text changes when at limit
   - Success alert shows remaining attempts after logging

### Files changed
- `TwoCupsApp/src/services/api/actions.ts` - Added getDailyAttemptsInfo function, added limit check to logAttempt
- `TwoCupsApp/src/services/api/index.ts` - Exported new function and type
- `TwoCupsApp/src/screens/LogAttemptScreen.tsx` - Added attempts counter UI and limit enforcement

### Acceptance Criteria Checklist
- [x] Query today's attempts by current user before allowing log
- [x] If >= 20 attempts today, show error message
- [x] Display remaining attempts count on Log Attempt screen
- [x] Counter resets at midnight (local time)

### Learnings
- Use `Timestamp.fromDate()` to convert JS Date to Firestore Timestamp for queries
- Client-side validation + server-side validation provides best UX
- Style concatenation with opacity (e.g., `colors.error + '20'`) works for semi-transparent backgrounds

---
